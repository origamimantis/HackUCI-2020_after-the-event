"use strict";

const uuid = require("uuid");

module.exports = class ImergoClass {
    constructor(config)
    {
        this.initDefaults();
        this.init(config);
    }

    initDefaults()
    {
        this.id = uuid.v1();
    }

    set id(value)
    {
        this._id = value;
    }

    get id()
    {
        return this._id;
    }

    toJSON()
    {
        let obj = {};
        Object.keys(this).map(key =>
        {
            if (key.charAt(0) === "_")
            {
                let newKey = key.substring(1);
                let property = this[key];
                if (property == null)
                {
                    obj[newKey] = null;
                }
                else if (property instanceof ImergoClass)
                {
                    obj[newKey] = property.toJSON();
                }
                else if (property instanceof Map)
                {
                    let arr = [];
                    for (let pair of property)
                    {
                        let o = [pair[0], pair[1]];
                        arr.push(o);
                    }
                    obj[newKey] = arr;
                }
                else if (Array.isArray(property))
                {
                    obj[newKey] = this[key];
                }
                else if (property[Symbol.iterator] && typeof property === "object")
                {
                    throw new RangeError(`Unknown collection to toJSON() method for ${property}.`);
                }
                else
                {
                    obj[newKey] = this[key];
                }
            }
        });
        return obj;
    }

    clone()
    {
        return new this.constructor(this);
    }

    init(config)
    {
        if (config !== null && typeof config === "object")
        {
            Object.keys(this).forEach(key =>
            {
                key = key.substring(1);
                let configProperty = config[key];
                if (typeof configProperty !== "undefined" && configProperty !== null)
                {
                    this[key] = configProperty;
                }
            });
        }
    }
};